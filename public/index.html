<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ULTIMATEFUTSERVICE CHAT</title>

  <style>
    :root { --primary:#00ffea; --bg-dark:#0a0f1f; --bg-light:#1a2238; }

    body{
      font-family:Arial,sans-serif;
      background:linear-gradient(145deg,var(--bg-dark),var(--bg-light));
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      margin:0;
      padding:1rem;
    }

    h2{
      color:var(--primary);
      margin-bottom:0.3rem;
      font-size:2rem;
      text-align:center;
    }

    /* ‚úÖ CONTADOR */
    #chatCounter{
      display:none;
      font-size:1.6rem;
      font-weight:bold;
      color:#00ffea;
      margin-bottom:1rem;
      text-align:center;
    }

    #exitBtn,#clearBtn{
      background:#ff4444;
      color:white;
      font-weight:bold;
      border:none;
      padding:10px 16px;
      border-radius:8px;
      margin-bottom:1rem;
      cursor:pointer;
    }

    #clearBtn{background:#ffaa00;}

    #topButtons{
      display:flex;
      gap:8px;
      margin-bottom:1rem;
    }

    #loginForm{
      background:rgba(0,0,0,.6);
      padding:2rem;
      border-radius:15px;
      width:100%;
      max-width:400px;
      display:flex;
      flex-direction:column;
      gap:1rem;
    }

    input,select,button{
      padding:12px;
      font-size:1rem;
      border-radius:8px;
      border:none;
    }

    input,select{
      background:rgba(255,255,255,.1);
      color:white;
    }

    button{
      background:var(--primary);
      color:#000;
      font-weight:bold;
      cursor:pointer;
    }

    #chat{
      list-style:none;
      padding:1rem;
      margin:1rem auto;
      background:rgba(0,0,0,.6);
      border-radius:15px;
      width:100%;
      max-width:700px;
      flex:1;
      overflow-y:auto;
      display:none;
      flex-direction:column;
      gap:10px;
    }

    #chat li{
      padding:10px;
      border-radius:12px;
      max-width:80%;
    }

    .client{background:#00ffea;color:#000;align-self:flex-start;}
    .player{background:#fff;color:#000;align-self:flex-end;}
    .admin{background:#ffcc00;color:#000;align-self:flex-end;}

    .time{font-size:.8em;opacity:.7;margin-top:4px;}

    #chatForm{
      display:none;
      width:100%;
      max-width:700px;
      gap:8px;
    }

    @media(max-width:768px){
      h2{font-size:1.6rem;}
      #chatCounter{font-size:1.3rem;}
    }
  </style>
</head>

<body>

  <h2>üí¨ ULTIMATEFUTSERVICE Chat</h2>
  <div id="chatCounter">‚è±Ô∏è 00:00</div>

  <div id="topButtons" style="display:none;">
    <button id="exitBtn">Exit Chat</button>
    <button id="clearBtn" style="display:none;">Clear Chat</button>
  </div>

  <div id="loginForm">
    <input id="chatIdInput" placeholder="Enter Order ID">
    <select id="userTypeSelect">
      <option value="">Select role</option>
      <option value="client">Client</option>
      <option value="player">Player</option>
      <option value="admin">Admin</option>
    </select>
    <input id="passwordInput" type="password" placeholder="Password" style="display:none">
    <button id="btnEnter">Enter</button>
  </div>

  <ul id="chat"></ul>

  <form id="chatForm">
    <input id="msg" placeholder="Type message..." style="flex:1">
    <button>Send</button>
  </form>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io({transports:['websocket','polling']});

const chatCounter = document.getElementById('chatCounter');
let counterInterval = null;
let counterSeconds = 0;

/* =========================
   ‚úÖ CONTADOR POR CHAT ID
========================= */

function counterKey(id){
  return 'ufs_counter_' + id;
}

function startCounter(id){
  stopCounter();
  counterSeconds = parseInt(localStorage.getItem(counterKey(id)) || '0');

  updateCounterUI();

  counterInterval = setInterval(()=>{
    counterSeconds++;
    localStorage.setItem(counterKey(id), counterSeconds);
    updateCounterUI();
  },1000);

  chatCounter.style.display = 'block';
}

function stopCounter(){
  if(counterInterval) clearInterval(counterInterval);
  counterInterval = null;
}

function updateCounterUI(){
  const m = String(Math.floor(counterSeconds/60)).padStart(2,'0');
  const s = String(counterSeconds%60).padStart(2,'0');
  chatCounter.textContent = `‚è±Ô∏è ${m}:${s}`;
}

/* =========================
   EXISTENTE (NO TOCADO)
========================= */

const chatUl = document.getElementById('chat');
const chatForm = document.getElementById('chatForm');
const msgInput = document.getElementById('msg');
const loginForm = document.getElementById('loginForm');
const topButtons = document.getElementById('topButtons');
const clearBtn = document.getElementById('clearBtn');

let chatId=null;
let userType=null;
let password='';

function showChat(){
  loginForm.style.display='none';
  chatUl.style.display='flex';
  chatForm.style.display='flex';
  topButtons.style.display='flex';
  clearBtn.style.display=(userType==='admin')?'block':'none';
  startCounter(chatId);
}

socket.on('joined',()=>{
  showChat();
  loadHistory();
});

function loadHistory(){
  fetch('/chat/'+chatId)
    .then(r=>r.json())
    .then(msgs=>{
      chatUl.innerHTML='';
      msgs.forEach(showMsg);
    });
}

function showMsg(m){
  const li=document.createElement('li');
  li.className =
    m.author==='Admin'?'admin':
    m.author==='Player'?'player':'client';
  li.innerHTML=`<b>${m.author}</b><br>${m.text}
    <div class="time">${new Date(m.time).toLocaleString()}</div>`;
  chatUl.appendChild(li);
  chatUl.scrollTop=chatUl.scrollHeight;
}

chatForm.onsubmit=e=>{
  e.preventDefault();
  if(!msgInput.value.trim())return;
  socket.emit('sendMessage',msgInput.value);
  msgInput.value='';
};

socket.on('receiveMessage',showMsg);

exitBtn.onclick=()=>{
  stopCounter();
  chatCounter.style.display='none';
  localStorage.removeItem('ufs_session');
  location.reload();
};
</script>

</body>
</html>

