<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ULTIMATEFUTSERVICE CHAT</title>

<style>
:root { --primary:#00ffea; --bg-dark:#0a0f1f; --bg-light:#1a2238; }
body{
  font-family:Arial,sans-serif;
  background:linear-gradient(145deg,var(--bg-dark),var(--bg-light));
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  margin:0;
  padding:1rem;
}
h2{color:var(--primary);}
button,input,select{padding:12px;border-radius:8px;border:none;font-size:1rem;}
input,select{background:rgba(255,255,255,.1);color:white;width:100%;}
button{background:var(--primary);font-weight:bold;cursor:pointer;}
button:hover{background:#00d4c2;}
#loginForm,#adminPanel,#chatContainer{
  background:rgba(0,0,0,.6);
  padding:1.5rem;
  border-radius:15px;
  width:100%;
  max-width:420px;
  margin-bottom:1rem;
}
#chatList li{
  list-style:none;
  padding:12px;
  border-bottom:1px solid rgba(255,255,255,.1);
  cursor:pointer;
}
#chatList li:hover{background:rgba(255,255,255,.1);}
#chat{
  list-style:none;
  padding:1rem;
  max-height:60vh;
  overflow-y:auto;
}
#chat li{margin-bottom:10px;padding:10px;border-radius:10px;}
.client{background:#00ffea;color:#000;}
.player{background:#fff;color:#000;}
.admin{background:#ffcc00;color:#000;}
#topButtons{display:flex;gap:8px;margin-bottom:1rem;}
#exitBtn{background:#ff4444;color:#fff;}
#clearBtn{background:#ffaa00;}
</style>
</head>

<body>

<h2>ðŸ’¬ ULTIMATEFUTSERVICE Chat</h2>

<!-- LOGIN -->
<div id="loginForm">
  <input id="chatIdInput" placeholder="Enter Order ID">
  <select id="userTypeSelect">
    <option value="">Select your role</option>
    <option value="client">Client</option>
    <option value="player">Player</option>
    <option value="admin">Admin</option>
  </select>
  <input id="passwordInput" type="password" placeholder="Password" style="display:none;">
  <button id="btnEnter">Enter</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" style="display:none;">
  <h3>ðŸ“‚ Active Chats</h3>
  <ul id="chatList"></ul>
</div>

<!-- CHAT -->
<div id="chatContainer" style="display:none;">
  <div id="topButtons">
    <button id="exitBtn">Exit</button>
    <button id="clearBtn">Clear Chat</button>
  </div>
  <ul id="chat"></ul>
  <form id="chatForm">
    <input id="msg" placeholder="Type a message">
    <button>Send</button>
  </form>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const loginForm = document.getElementById('loginForm');
const adminPanel = document.getElementById('adminPanel');
const chatContainer = document.getElementById('chatContainer');
const chatUl = document.getElementById('chat');
const chatList = document.getElementById('chatList');

const chatIdInput = document.getElementById('chatIdInput');
const userTypeSelect = document.getElementById('userTypeSelect');
const passwordInput = document.getElementById('passwordInput');
const msgInput = document.getElementById('msg');

let chatId = null;
let userType = null;

userTypeSelect.onchange = () => {
  passwordInput.style.display =
    (userTypeSelect.value === 'player' || userTypeSelect.value === 'admin')
    ? 'block' : 'none';
};

document.getElementById('btnEnter').onclick = () => {
  userType = userTypeSelect.value;
  chatId = chatIdInput.value.trim();

  if (!userType) return alert('Select role');

  socket.emit('joinChat', {
    type: userType,
    id: userType === 'admin' ? null : chatId,
    password: passwordInput.value
  });
};

socket.on('joined', (data) => {
  loginForm.style.display = 'none';

  if (data.adminPanel) {
    adminPanel.style.display = 'block';
    loadAdminChats();
  } else {
    openChat();
  }
});

function loadAdminChats() {
  fetch('/api/admin/chats')
    .then(r=>r.json())
    .then(chats=>{
      chatList.innerHTML='';
      chats.forEach(id=>{
        const li=document.createElement('li');
        li.textContent=id;
        li.onclick=()=>enterChatAsAdmin(id);
        chatList.appendChild(li);
      });
    });
}

function enterChatAsAdmin(id) {
  chatId=id;
  socket.emit('joinChat',{type:'admin',id,password:passwordInput.value});
  adminPanel.style.display='none';
  openChat();
}

function openChat() {
  chatContainer.style.display='block';
  loadHistory();
}

function loadHistory() {
  fetch(`/chat/${chatId}`)
    .then(r=>r.json())
    .then(msgs=>{
      chatUl.innerHTML='';
      msgs.forEach(showMsg);
    });
}

function showMsg(m) {
  const li=document.createElement('li');
  li.className = m.author==='Admin'?'admin':m.author==='Player'?'player':'client';
  li.innerHTML = `<b>${m.author}</b><br>${m.text}`;
  chatUl.appendChild(li);
}

document.getElementById('chatForm').onsubmit = e => {
  e.preventDefault();
  if(!msgInput.value.trim())return;
  socket.emit('sendMessage',msgInput.value);
  msgInput.value='';
};

socket.on('receiveMessage',showMsg);

document.getElementById('exitBtn').onclick=()=>{
  location.reload();
};

document.getElementById('clearBtn').onclick=()=>{
  if(confirm('Clear chat?')) socket.emit('clearChat');
};

socket.on('chatCleared',()=>chatUl.innerHTML='');
</script>
</body>
</html>
