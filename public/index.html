<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ULTIMATEFUTSERVICE CHAT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 2rem;
      background: #e5ddd5;
    }
    #chat {
      list-style: none;
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #chat li {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 15px;
      max-width: 60%;
      position: relative;
    }
    .cliente {
      background: #dcf8c6;
      align-self: flex-start;
    }
    .jugador, .admin {
      background: #ffffff;
      align-self: flex-end;
      margin-left: auto;
    }
    .hora {
      font-size: 0.8em;
      color: gray;
      margin-top: 5px;
    }
    input, button {
      padding: 8px;
      font-size: 1rem;
      margin-bottom: 1rem;
      width: 100%;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #loginForm {
      max-width: 400px;
      margin: auto;
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <h2>Chat Anónimo FIFA</h2>

  <div id="loginForm">
    <input id="chatIdInput" placeholder="Introduce ID del pedido" autocomplete="off" />
    <select id="userTypeSelect">
      <option value="">Selecciona tu rol</option>
      <option value="cliente">Cliente</option>
      <option value="jugador">Jugador</option>
      <option value="admin">Admin</option>
    </select>
    <input id="passwordInput" type="password" placeholder="Contraseña (solo jugador/admin)" style="display:none;" autocomplete="off" />
    <button id="btnEnter">Entrar al chat</button>
  </div>

  <ul id="chat" style="display:none;"></ul>

  <input id="msg" placeholder="Escribe tu mensaje..." autofocus style="display:none;" autocomplete="off"/>
  <button id="btnSend" style="display:none;">Enviar</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const chatIdInput = document.getElementById('chatIdInput');
    const userTypeSelect = document.getElementById('userTypeSelect');
    const passwordInput = document.getElementById('passwordInput');
    const btnEnter = document.getElementById('btnEnter');
    const chatUl = document.getElementById('chat');
    const msgInput = document.getElementById('msg');
    const btnSend = document.getElementById('btnSend');
    const loginForm = document.getElementById('loginForm');

    let chatId = null;
    let userType = null;

    userTypeSelect.addEventListener('change', () => {
      if (userTypeSelect.value === 'jugador' || userTypeSelect.value === 'admin') {
        passwordInput.style.display = 'block';
      } else {
        passwordInput.style.display = 'none';
        passwordInput.value = '';
      }
    });

    btnEnter.addEventListener('click', () => {
      chatId = chatIdInput.value.trim();
      userType = userTypeSelect.value;
      const password = passwordInput.value;

      if (!chatId) return alert('Debes introducir un ID del pedido.');
      if (!['cliente', 'jugador', 'admin'].includes(userType)) return alert('Selecciona un rol válido.');

      // Enviar joinChat con password si aplica
      socket.emit('joinChat', { type: userType, id: chatId, password });

      socket.once('errorMsg', (msg) => {
        alert(msg);
      });

      socket.once('joined', (data) => {
        if (data.success) {
          loginForm.style.display = 'none';
          chatUl.style.display = 'flex';
          msgInput.style.display = 'inline-block';
          btnSend.style.display = 'inline-block';
          cargarHistorial();
        }
      });
    });

    function mostrarMensaje(msg) {
      const li = document.createElement('li');
      let clase = 'cliente';
      if (msg.autor.includes('Jugador')) clase = 'jugador';
      if (msg.autor === 'Admin') clase = 'admin';

      li.className = clase;
      li.innerHTML = `<strong>${msg.autor}</strong><br>${msg.texto}<div class="hora">${new Date(msg.hora).toLocaleString()}</div>`;
      chatUl.appendChild(li);
      chatUl.scrollTop = chatUl.scrollHeight;
    }

    async function cargarHistorial() {
      try {
        const res = await fetch(`/chat/${chatId}`);
        const mensajes = await res.json();
        mensajes.forEach(mostrarMensaje);
      } catch (err) {
        alert('Error cargando historial');
      }
    }

    socket.on('receiveMessage', mostrarMensaje);

    btnSend.addEventListener('click', () => {
      enviar();
    });

    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') enviar();
    });

    function enviar() {
      const msg = msgInput.value.trim();
      if (!msg) return;
      socket.emit('sendMessage', msg);
      msgInput.value = '';
    }
  </script>
</body>
</html>

