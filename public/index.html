<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ULTIMATEFUTSERVICE CHAT</title>

<style>
:root { --primary:#00ffea; --bg-dark:#0a0f1f; --bg-light:#1a2238; }

body{
  font-family:Arial,sans-serif;
  background:linear-gradient(145deg,var(--bg-dark),var(--bg-light));
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  margin:0;
  padding:1rem;
}

h2{color:var(--primary);margin-bottom:0.5rem;font-size:1.8rem;text-align:center;}

#loginForm,#adminList{
  background:rgba(0,0,0,.6);
  padding:2rem;
  border-radius:15px;
  box-shadow:0 4px 10px rgba(0,0,0,.5);
  width:100%;
  max-width:420px;
  display:flex;
  flex-direction:column;
  gap:1rem;
}

input,select,button{
  padding:12px;
  font-size:1rem;
  border-radius:8px;
  border:none;
  outline:none;
}

input,select{background:rgba(255,255,255,.1);color:white;width:100%;}
input::placeholder{color:rgba(255,255,255,.6);}
select option{background:#1a2238;color:#fff;}

button{
  background:var(--primary);
  color:#000;
  font-weight:bold;
  cursor:pointer;
}

button:hover{background:#00d4c2}

#chat{
  list-style:none;
  padding:1rem;
  flex:1;
  overflow-y:auto;
  margin:1rem auto;
  background:rgba(0,0,0,.6);
  border-radius:15px;
  width:100%;
  max-width:700px;
  display:none;
  flex-direction:column;
  gap:10px;
}

#chat li{
  padding:10px;
  border-radius:12px;
  max-width:80%;
  word-wrap:break-word;
}

.client{background:#00ffea;color:#000;align-self:flex-start;}
.player{background:#fff;color:#000;align-self:flex-end;}
.admin{background:#ffcc00;color:#000;align-self:flex-end;}

.time{font-size:.75em;color:#ddd;margin-top:4px;}

#chatForm{
  display:none;
  width:100%;
  max-width:700px;
  gap:8px;
}

#msg{flex:1;background:rgba(255,255,255,.1);color:white;}

#topButtons{
  display:none;
  gap:8px;
  margin-bottom:1rem;
}

#exitBtn,#clearBtn{
  background:#ff4444;
  color:white;
  font-weight:bold;
}

#clearBtn{background:#ffaa00}

/* ADMIN LIST */
#adminList{display:none;}
.chatItem{
  background:rgba(255,255,255,.08);
  padding:12px;
  border-radius:10px;
  cursor:pointer;
}
.chatItem:hover{background:rgba(255,255,255,.15)}
.chatTitle{font-weight:bold;color:var(--primary)}
.chatLast{font-size:.9em;color:#ccc}
.chatMeta{font-size:.75em;color:#aaa;margin-top:4px}

@media(max-width:768px){
  h2{font-size:1.4rem}
  #chat{max-height:65vh}
}
</style>
</head>

<body>

<h2>ðŸ’¬ ULTIMATEFUTSERVICE Chat</h2>

<div id="topButtons">
  <button id="exitBtn">Exit</button>
  <button id="clearBtn" style="display:none;">Clear Chat</button>
</div>

<!-- LOGIN -->
<div id="loginForm">
  <input id="chatIdInput" placeholder="Enter Order ID">
  <select id="userType">
    <option value="">Select role</option>
    <option value="client">Client</option>
    <option value="player">Player</option>
    <option value="admin">Admin</option>
  </select>
  <input id="password" type="password" placeholder="Admin / Player password" style="display:none">
  <button id="enterBtn">Enter</button>
</div>

<!-- ADMIN CHAT LIST -->
<div id="adminList"></div>

<!-- CHAT -->
<ul id="chat"></ul>

<form id="chatForm">
  <input id="msg" placeholder="Type message...">
  <button>Send</button>
</form>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io({transports:['websocket','polling']});

const loginForm = document.getElementById('loginForm');
const adminList = document.getElementById('adminList');
const chatUl = document.getElementById('chat');
const chatForm = document.getElementById('chatForm');
const msgInput = document.getElementById('msg');
const topButtons = document.getElementById('topButtons');
const clearBtn = document.getElementById('clearBtn');

let userType = null;
let chatId = null;

// ROLE CHANGE
userTypeSelect = document.getElementById('userType');
userTypeSelect.onchange = () => {
  password.style.display = (userTypeSelect.value !== 'client') ? 'block' : 'none';
  chatIdInput.style.display = (userTypeSelect.value === 'admin') ? 'none' : 'block';
};

// ENTER
enterBtn.onclick = () => {
  userType = userTypeSelect.value;
  const pass = password.value;
  chatId = chatIdInput.value.trim();

  if (!userType) return alert('Select role');

  if (userType === 'admin') {
    socket.emit('adminLogin', { password: pass });
  } else {
    if (!chatId) return alert('Order ID required');
    socket.emit('joinChat', { type:userType, id:chatId, password:pass });
  }
};

// ADMIN LIST
socket.on('adminChats', chats => {
  loginForm.style.display = 'none';
  adminList.style.display = 'flex';
  adminList.innerHTML = '';

  chats.forEach(c => {
    const div = document.createElement('div');
    div.className = 'chatItem';
    div.innerHTML = `
      <div class="chatTitle">Order ${c.chatId}</div>
      <div class="chatLast">${c.lastText || ''}</div>
      <div class="chatMeta">${c.time || ''} Â· ${c.unread} unread</div>
    `;
    div.onclick = () => {
      chatId = c.chatId;
      socket.emit('joinChat', { type:'admin', id:chatId, password:password.value });
    };
    adminList.appendChild(div);
  });
});

// JOINED CHAT
socket.on('joined', () => {
  adminList.style.display = 'none';
  chatUl.style.display = 'flex';
  chatForm.style.display = 'flex';
  topButtons.style.display = 'flex';
  clearBtn.style.display = (userType === 'admin') ? 'inline-block' : 'none';
  loadHistory();
});

// MESSAGES
socket.on('receiveMessage', msg => {
  const li = document.createElement('li');
  li.className = msg.author.toLowerCase();
  li.innerHTML = `<b>${msg.author}</b><br>${msg.text}<div class="time">${new Date(msg.time).toLocaleString()}</div>`;
  chatUl.appendChild(li);
  chatUl.scrollTop = chatUl.scrollHeight;
});

// SEND
chatForm.onsubmit = e => {
  e.preventDefault();
  if (!msgInput.value.trim()) return;
  socket.emit('sendMessage', msgInput.value.trim());
  msgInput.value = '';
};

// LOAD HISTORY
async function loadHistory(){
  chatUl.innerHTML = '';
  const res = await fetch('/chat/' + chatId);
  (await res.json()).forEach(m => socket.emit('receiveMessage', m));
}
</script>
</body>
</html>
