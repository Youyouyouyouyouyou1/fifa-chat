<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ULTIMATEFUTSERVICE CHAT</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(145deg, #0a0f1f, #1a2238);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 1rem;
    }

    h2 {
      text-align: center;
      margin-bottom: 2rem;
      color: #00ffea;
    }

    #loginForm {
      background: rgba(0, 0, 0, 0.6);
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    input, select, button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      outline: none;
    }

    input, select {
      background: rgba(255,255,255,0.1);
      color: white;
    }

    input::placeholder {
      color: rgba(255,255,255,0.6);
    }

    select option {
      background: #1a2238;
      color: #fff;
    }

    button {
      background: #00ffea;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s ease;
    }

    button:hover {
      background: #00d4c2;
      transform: scale(1.03);
    }

    #chat {
      list-style: none;
      padding: 1rem;
      max-height: 500px;
      overflow-y: auto;
      margin: 1rem auto;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 15px;
      width: 100%;
      max-width: 700px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #chat li {
      padding: 10px;
      border-radius: 12px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .client {
      background: #00ffea;
      color: #000;
      align-self: flex-start;
    }

    .player {
      background: #fff;
      color: #000;
      align-self: flex-end;
    }

    .admin {
      background: #ffcc00;
      color: #000;
      align-self: flex-end;
    }

    .time {
      font-size: 0.8em;
      color: rgba(255,255,255,0.7);
      margin-top: 5px;
    }

    #msg, #btnSend {
      max-width: 700px;
      width: 100%;
    }

    #msg {
      background: rgba(255,255,255,0.1);
      color: white;
      padding: 10px;
      margin-bottom: 0.5rem;
    }

    #msg::placeholder {
      color: rgba(255,255,255,0.6);
    }

  </style>
</head>
<body>
  <h2>ðŸ’¬ ULTIMATEFUTSERVICE Chat</h2>

  <div id="loginForm">
    <input id="chatIdInput" placeholder="Enter Order ID" autocomplete="off" />
    <select id="userTypeSelect">
      <option value="">Select your role</option>
      <option value="client">Client</option>
      <option value="player">Player</option>
      <option value="admin">Admin</option>
    </select>
    <input id="passwordInput" type="password" placeholder="Password (only player/admin)" style="display:none;" autocomplete="off" />
    <button id="btnEnter">Enter Chat</button>
  </div>

  <ul id="chat" style="display:none;"></ul>

  <input id="msg" placeholder="Type your message..." autofocus style="display:none;" autocomplete="off"/>
  <button id="btnSend" style="display:none;">Send</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const chatIdInput = document.getElementById('chatIdInput');
    const userTypeSelect = document.getElementById('userTypeSelect');
    const passwordInput = document.getElementById('passwordInput');
    const btnEnter = document.getElementById('btnEnter');
    const chatUl = document.getElementById('chat');
    const msgInput = document.getElementById('msg');
    const btnSend = document.getElementById('btnSend');
    const loginForm = document.getElementById('loginForm');

    let chatId = null;
    let userType = null;

    userTypeSelect.addEventListener('change', () => {
      passwordInput.style.display = (userTypeSelect.value === 'player' || userTypeSelect.value === 'admin') ? 'block' : 'none';
    });

    btnEnter.addEventListener('click', () => {
      chatId = chatIdInput.value.trim();
      userType = userTypeSelect.value;
      const password = passwordInput.value;

      if (!chatId) return alert('You must enter an Order ID.');
      if (!['client', 'player', 'admin'].includes(userType)) return alert('Please select a valid role.');

      socket.emit('joinChat', { type: userType, id: chatId, password });

      socket.once('errorMsg', (msg) => alert(msg));

      socket.once('joined', (data) => {
        if (data.success) {
          loginForm.style.display = 'none';
          chatUl.style.display = 'flex';
          msgInput.style.display = 'inline-block';
          btnSend.style.display = 'inline-block';
          loadHistory();
        }
      });
    });

    function showMessage(msg) {
      const li = document.createElement('li');
      let cls = 'client';
      if (msg.author.includes('Player')) cls = 'player';
      if (msg.author === 'Admin') cls = 'admin';

      li.className = cls;
      li.innerHTML = `<strong>${msg.author}</strong><br>${msg.text}<div class="time">${new Date(msg.time).toLocaleString()}</div>`;
      chatUl.appendChild(li);
      chatUl.scrollTop = chatUl.scrollHeight;
    }

    async function loadHistory() {
      try {
        const res = await fetch(`/chat/${chatId}`);
        const messages = await res.json();
        messages.forEach(showMessage);
      } catch {
        alert('Error loading history');
      }
    }

    socket.on('receiveMessage', showMessage);

    btnSend.addEventListener('click', send);
    msgInput.addEventListener('keydown', (e) => e.key === 'Enter' && send());

    function send() {
      const msg = msgInput.value.trim();
      if (!msg) return;
      socket.emit('sendMessage', msg);
      msgInput.value = '';
    }
  </script>
</body>
</html>
